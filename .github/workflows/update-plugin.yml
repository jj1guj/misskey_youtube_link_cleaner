name: build-and-deploy-plugin
on:
  push:
    branches: [main]
    paths:
      - 'main.ais'          # ãƒ—ãƒ©ã‚°ã‚¤ãƒ³æœ¬ä½“ãŒå¤‰ã‚ã£ãŸã¨ãã ã‘èµ·å‹•

jobs:
  generate:
    runs-on: ubuntu-latest

    # ----- GITHUB_TOKEN ã«æ›¸ãè¾¼ã¿æ¨©é™ã‚’ä»˜ä¸ -----
    permissions:
      contents: write   # â† ã“ã‚ŒãŒãªã„ã¨ push ã§ãã¾ã›ã‚“

    steps:
    # 1) ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
    - uses: actions/checkout@v4   # æœ€æ–°ç‰ˆ

    # 2) plugin.json ã‚’ãƒ¯ãƒ³ãƒ©ã‚¤ãƒŠãƒ¼ã§ç”Ÿæˆ (jq -R -s)
    - name: Build plugin.json
      run: |
        jq -R -s '{type:"plugin",data:.}' main.ais > plugin.json

    # 3) SHA-512 ã‚’è¨ˆç®—ã—ã¦å¾Œç¶šã‚¹ãƒ†ãƒƒãƒ—ã¸æ¸¡ã™
    - name: Calculate SHA512
      id: hash
      run: |
        HASH=$(sha512sum main.ais | cut -d' ' -f1)
        echo "hash=$HASH" >> "$GITHUB_OUTPUT"

    # 4) README ã¨ Web é…å¸ƒãƒšãƒ¼ã‚¸ (install.html) ä¸­ã®ãƒãƒƒã‚·ãƒ¥ã‚’ç½®æ›
    - name: Patch hash everywhere
      run: |
        NEW=${{ steps.hash.outputs.hash }}
        # README:  hash=xxxxxxxx(128)
        sed -Ei "s/hash=[0-9a-f]{128}/hash=${NEW}/" README.md
        # install.html: const HASH = 'xxxxxxxx(128)';
        sed -zEi "s/const[[:space:]]+HASH[[:space:]]*=[[:space:]]*\\\"[0-9a-f]{128}\\\"/const HASH = \\\"${NEW}\\\"/" install.html

    # 5) å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆã—ã¦ main ã¸ãƒ—ãƒƒã‚·ãƒ¥
    - name: Commit and push
      uses: stefanzweifel/git-auto-commit-action@v6
      with:
        commit_message: "chore: regenerate plugin.json and hash ğŸ¤–"
        push_options: --force-with-lease

    # 6) (ä»»æ„) GitHub Pages ã¸å…¬é–‹
    - name: Deploy to Pages
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_branch: gh-pages
        publish_dir: .         # plugin.json ã¨ docs/ ãŒãƒªãƒã‚¸ãƒˆãƒªç›´ä¸‹ã«ã‚ã‚‹å ´åˆ
